/*! grafana - v4.0.2-1481203731 - 2016-12-08
 * Copyright (c) 2016 Torkel Ã–degaard; Licensed Apache-2.0 */

System.register(["lodash","moment","../../../features/alerting/alert_def","app/plugins/sdk","app/core/utils/datemath"],function(a){var b,c,d,e,f,g,h=this&&this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);a.prototype=null===b?Object.create(b):(c.prototype=b.prototype,new c)};return{setters:[function(a){b=a},function(a){c=a},function(a){d=a},function(a){e=a},function(a){f=a}],execute:function(){g=function(a){function e(c,d,e,f,g,h){a.call(this,c,d),this.$location=e,this.backendSrv=f,this.timeSrv=g,this.templateSrv=h,this.showOptions=[{text:"Current state",value:"current"},{text:"Recent state changes",value:"changes"}],this.stateFilter={},this.currentAlerts=[],this.alertHistory=[],this.panelDefaults={show:"current",limit:10,stateFilter:[],onlyAlertsOnDashboard:!1},b["default"].defaults(this.panel,this.panelDefaults),this.events.on("init-edit-mode",this.onInitEditMode.bind(this)),this.events.on("render",this.onRender.bind(this)),this.events.on("refresh",this.onRender.bind(this));for(var i in this.panel.stateFilter)this.stateFilter[this.panel.stateFilter[i]]=!0}return h(e,a),e.$inject=["$scope","$injector","$location","backendSrv","timeSrv","templateSrv"],e.prototype.updateStateFilter=function(){var a=[];for(var b in this.stateFilter)this.stateFilter[b]&&a.push(b);this.panel.stateFilter=a,this.onRender()},e.prototype.onRender=function(){this.contentHeight="max-height: "+this.height+"px;","current"===this.panel.show&&this.getCurrentAlertState(),"changes"===this.panel.show&&this.getStateChanges()},e.prototype.getStateChanges=function(){var a=this,e={limit:this.panel.limit,type:"alert",newState:this.panel.stateFilter};this.panel.onlyAlertsOnDashboard&&(e.dashboardId=this.dashboard.id),e.from=1e3*f.parse(this.dashboard.time.from).unix(),e.to=1e3*f.parse(this.dashboard.time.to).unix(),this.backendSrv.get("/api/annotations",e).then(function(e){a.alertHistory=b["default"].map(e,function(a){return a.time=c["default"](a.time).format("MMM D, YYYY HH:mm:ss"),a.stateModel=d["default"].getStateDisplayModel(a.newState),a.metrics=d["default"].joinEvalMatches(a.data,", "),a})})},e.prototype.getCurrentAlertState=function(){var a=this,e={state:this.panel.stateFilter};this.panel.onlyAlertsOnDashboard&&(e.dashboardId=this.dashboard.id),this.backendSrv.get("/api/alerts",e).then(function(e){a.currentAlerts=b["default"].map(e,function(a){return a.stateModel=d["default"].getStateDisplayModel(a.state),a.newStateDateAgo=c["default"](a.newStateDate).fromNow().replace(" ago",""),a})})},e.prototype.onInitEditMode=function(){this.addEditorTab("Options","public/app/plugins/panel/alertlist/editor.html")},e.templateUrl="module.html",e}(e.PanelCtrl),a("AlertListPanel",g),a("PanelCtrl",g)}}});