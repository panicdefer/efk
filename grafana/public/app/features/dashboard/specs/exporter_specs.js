/*! grafana - v4.0.2-1481203731 - 2016-12-08
 * Copyright (c) 2016 Torkel Ã–degaard; Licensed Apache-2.0 */

System.register(["test/lib/common","lodash","app/core/config","../export/exporter","../model"],function(a){var b,c,d,e,f;return{setters:[function(a){b=a},function(a){c=a},function(a){d=a},function(a){e=a},function(a){f=a}],execute:function(){b.describe("given dashboard with repeated panels",function(){var a,g;b.beforeEach(function(c){a={rows:[],templating:{list:[]},annotations:{list:[]}},d["default"].buildInfo={version:"3.0.2"},a.templating.list.push({name:"apps",type:"query",datasource:"gfdb",current:{value:"Asd",text:"Asd"},options:[{value:"Asd",text:"Asd"}]}),a.templating.list.push({name:"prefix",type:"constant",current:{value:"collectd",text:"collectd"},options:[]}),a.templating.list.push({name:"ds",type:"datasource",query:"testdb",current:{value:"prod",text:"prod"},options:[]}),a.annotations.list.push({name:"logs",datasource:"gfdb"}),a.rows.push({repeat:"test",panels:[{id:2,repeat:"apps",datasource:"gfdb",type:"graph"},{id:3,repeat:null,repeatPanelId:2},{id:4,datasource:"-- Mixed --",targets:[{datasource:"other"}]},{id:5,datasource:"$ds"}]}),a.rows.push({repeat:null,repeatRowId:1,panels:[]});var h={get:b.sinon.stub()};h.get.withArgs("gfdb").returns(Promise.resolve({name:"gfdb",meta:{id:"testdb",info:{version:"1.2.1"},name:"TestDB"}})),h.get.withArgs("other").returns(Promise.resolve({name:"other",meta:{id:"other",info:{version:"1.2.1"},name:"OtherDB"}})),h.get.withArgs("-- Mixed --").returns(Promise.resolve({name:"mixed",meta:{id:"mixed",info:{version:"1.2.1"},name:"Mixed",builtIn:!0}})),d["default"].panels.graph={id:"graph",name:"Graph",info:{version:"1.1.0"}},a=new f.DashboardModel(a,{});var i=new e.DashboardExporter(h);i.makeExportable(a).then(function(a){g=a,c()})}),b.it("exported dashboard should not contain repeated panels",function(){b.expect(g.rows[0].panels.length).to.be(3)}),b.it("exported dashboard should not contain repeated rows",function(){b.expect(g.rows.length).to.be(1)}),b.it("should replace datasource refs",function(){var a=g.rows[0].panels[0];b.expect(a.datasource).to.be("${DS_GFDB}")}),b.it("should replace datasource in variable query",function(){b.expect(g.templating.list[0].datasource).to.be("${DS_GFDB}"),b.expect(g.templating.list[0].options.length).to.be(0),b.expect(g.templating.list[0].current.value).to.be(void 0),b.expect(g.templating.list[0].current.text).to.be(void 0)}),b.it("should replace datasource in annotation query",function(){b.expect(g.annotations.list[0].datasource).to.be("${DS_GFDB}")}),b.it("should add datasource as input",function(){b.expect(g.__inputs[0].name).to.be("DS_GFDB"),b.expect(g.__inputs[0].pluginId).to.be("testdb"),b.expect(g.__inputs[0].type).to.be("datasource")}),b.it("should add datasource to required",function(){var a=c["default"].find(g.__requires,{name:"TestDB"});b.expect(a.name).to.be("TestDB"),b.expect(a.id).to.be("testdb"),b.expect(a.type).to.be("datasource"),b.expect(a.version).to.be("1.2.1")}),b.it("should not add built in datasources to required",function(){var a=c["default"].find(g.__requires,{name:"Mixed"});b.expect(a).to.be(void 0)}),b.it("should add datasources used in mixed mode",function(){var a=c["default"].find(g.__requires,{name:"OtherDB"});b.expect(a).to.not.be(void 0)}),b.it("should add panel to required",function(){var a=c["default"].find(g.__requires,{name:"Graph"});b.expect(a.name).to.be("Graph"),b.expect(a.id).to.be("graph"),b.expect(a.version).to.be("1.1.0")}),b.it("should add grafana version",function(){var a=c["default"].find(g.__requires,{name:"Grafana"});b.expect(a.type).to.be("grafana"),b.expect(a.id).to.be("grafana"),b.expect(a.version).to.be("3.0.2")}),b.it("should add constant template variables as inputs",function(){var a=c["default"].find(g.__inputs,{name:"VAR_PREFIX"});b.expect(a.type).to.be("constant"),b.expect(a.label).to.be("prefix"),b.expect(a.value).to.be("collectd")}),b.it("should templatize constant variables",function(){var a=c["default"].find(g.templating.list,{name:"prefix"});b.expect(a.query).to.be("${VAR_PREFIX}"),b.expect(a.current.text).to.be("${VAR_PREFIX}"),b.expect(a.current.value).to.be("${VAR_PREFIX}"),b.expect(a.options[0].text).to.be("${VAR_PREFIX}"),b.expect(a.options[0].value).to.be("${VAR_PREFIX}")})})}}});